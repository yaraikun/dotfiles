#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   convertify <ext1> <ext2> ... -o <output_ext> [--append] [--dry-run] [--yes]
#   convertify -o <output_ext> <ext1> <ext2> ...
#
# Examples:
#   convertify tsx ts html -o txt
#   convertify tsx ts -o txt --append   # app.tsx -> app.tsx.txt

OUTPUT=""
INPUT_EXTS=()
DRY_RUN=false
AUTO_CONFIRM=false
APPEND=false

# -------- Parse args --------
while [[ $# -gt 0 ]]; do
  case "$1" in
    -o)
      shift
      OUTPUT="${1:-}"
      ;;
    --dry-run)
      DRY_RUN=true
      ;;
    --yes)
      AUTO_CONFIRM=true
      ;;
    --append)
      APPEND=true
      ;;
    *)
      INPUT_EXTS+=("$1")
      ;;
  esac
  shift
done

# -------- Validation --------
if [[ -z "$OUTPUT" ]]; then
  echo "✖ Missing output type. Use -o <ext>"
  exit 1
fi

if [[ ${#INPUT_EXTS[@]} -eq 0 ]]; then
  echo "✖ Provide at least one input extension."
  exit 1
fi

TARGET_DIR="convertify"
mkdir -p "$TARGET_DIR"

echo "--- Configuration ---"
echo "Output type: .$OUTPUT"
echo "Input types: ${INPUT_EXTS[*]}"
echo "Mode: $([[ $APPEND == true ]] && echo 'append' || echo 'replace')"
echo

# -------- Collect files --------
FILES=()

for ext in "${INPUT_EXTS[@]}"; do
  while IFS= read -r -d '' file; do
    FILES+=("$file")
  done < <(find . -type f -name "*.$ext" -print0)
done

if [[ ${#FILES[@]} -eq 0 ]]; then
  echo "✖ No matching files found."
  exit 1
fi

echo "Found ${#FILES[@]} file(s) to convert."

# -------- Confirm --------
if ! $AUTO_CONFIRM; then
  echo
  read -rp "Proceed converting to .$OUTPUT? [y/N]: " confirm
  [[ "$confirm" =~ ^[Yy]$ ]] || {
    echo "Cancelled."
    exit 0
  }
fi

echo
echo "--- Converting ---"

for file in "${FILES[@]}"; do
  base_name=$(basename "$file")

  if $APPEND; then
    # app.tsx -> app.tsx.txt
    new_name="${base_name}.${OUTPUT}"
  else
    # app.tsx -> app.txt
    clean_name="${base_name%.*}"
    new_name="${clean_name}.${OUTPUT}"
  fi

  new_file_path="${TARGET_DIR}/${new_name}"

  if [[ -e "$new_file_path" ]]; then
    echo "⚠ Skipping (exists): $new_file_path"
    continue
  fi

  if $DRY_RUN; then
    echo "[dry-run] Would copy '$file' → '$new_file_path'"
  else
    cp "$file" "$new_file_path"
    echo "Copied '$file' → '$new_file_path'"
  fi
done

echo
echo "✔ Done. All outputs in '$TARGET_DIR/'"
