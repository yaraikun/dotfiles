#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   rebaser <base-branch> [--dry-run] [--yes]
# Example:
#   rebaser develop

BASE_BRANCH="${1:-}"

DRY_RUN=false
AUTO_CONFIRM=false

for arg in "$@"; do
  case "$arg" in
    --dry-run) DRY_RUN=true ;;
    --yes) AUTO_CONFIRM=true ;;
  esac
done

run() {
  if $DRY_RUN; then
    echo "  ${DIM}[dry-run]${RESET} $*"
  else
    "$@"
  fi
}

# ---------- Styling ----------
if [[ -t 1 ]]; then
  BOLD=$(tput bold)
  DIM=$(tput dim)
  RESET=$(tput sgr0)
  GREEN=$(tput setaf 2)
  YELLOW=$(tput setaf 3)
  BLUE=$(tput setaf 4)
  RED=$(tput setaf 1)
else
  BOLD=""; DIM=""; RESET=""
  GREEN=""; YELLOW=""; BLUE=""; RED=""
fi

section() { echo -e "\n${BOLD}${BLUE}==> $1${RESET}"; }
step()    { echo "  ${GREEN}•${RESET} $1"; }
warn()    { echo "  ${YELLOW}!${RESET} $1"; }
error()   { echo "  ${RED}✖${RESET} $1"; }

# ---------- Args ----------
if [[ -z "$BASE_BRANCH" ]]; then
  error "Missing base branch"
  echo "Usage: rebaser <base-branch> [--dry-run] [--yes]"
  exit 1
fi

# ---------- Pre-flight safety ----------
section "Pre-flight checks"

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  error "Not inside a git repository"
  exit 1
fi

if ! git diff-index --quiet HEAD --; then
  error "Uncommitted changes detected. Commit or stash first."
  exit 1
fi

FEATURE_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [[ "$FEATURE_BRANCH" == "$BASE_BRANCH" ]]; then
  error "You are already on '$BASE_BRANCH'. Checkout your feature branch first."
  exit 1
fi

step "Feature branch: ${BOLD}$FEATURE_BRANCH${RESET}"
step "Base branch:    ${BOLD}$BASE_BRANCH${RESET}"

# Verify base exists
if ! git show-ref --verify --quiet "refs/heads/$BASE_BRANCH" &&
   ! git ls-remote --exit-code --heads origin "$BASE_BRANCH" >/dev/null 2>&1; then
  error "Base branch '$BASE_BRANCH' not found locally or on origin"
  exit 1
fi

# ---------- Fetch ----------
section "Fetching latest from remote"
run git fetch --all --prune

# ---------- Update base branch ----------
section "Updating base branch"

run git checkout "$BASE_BRANCH" >/dev/null 2>&1
step "Checked out $BASE_BRANCH"

if git rev-parse --symbolic-full-name "$BASE_BRANCH@{u}" >/dev/null 2>&1; then
  step "Pulling base (fast-forward only)"
  run git pull --ff-only
else
  warn "No remote tracking branch for base — skipping pull"
fi

# ---------- Update feature branch ----------
section "Updating feature branch"

run git checkout "$FEATURE_BRANCH" >/dev/null 2>&1
step "Checked out $FEATURE_BRANCH"

if git rev-parse --symbolic-full-name "$FEATURE_BRANCH@{u}" >/dev/null 2>&1; then
  step "Pulling feature (fast-forward only)"
  run git pull --ff-only
else
  warn "No remote tracking branch for feature — skipping pull"
fi

# ---------- Confirm ----------
section "Rebase plan"
echo "  Rebase: ${BOLD}$FEATURE_BRANCH${RESET}"
echo "  Onto:   ${BOLD}$BASE_BRANCH${RESET}"

if ! $AUTO_CONFIRM; then
  echo
  read -rp "Proceed with rebase? [y/N]: " confirm
  [[ "$confirm" =~ ^[Yy]$ ]] || {
    warn "Rebase cancelled"
    exit 0
  }
fi

# ---------- Rebase ----------
section "Rebasing"

if $DRY_RUN; then
  step "[dry-run] git rebase $BASE_BRANCH"
else
  if git rebase "$BASE_BRANCH"; then
    echo
    echo "${GREEN}✔ Rebase successful${RESET}"
  else
    echo
    error "Rebase conflict detected"
    echo
    echo "  Resolve conflicts, then run:"
    echo "    ${BOLD}git rebase --continue${RESET}"
    echo
    echo "  Or abort safely:"
    echo "    ${BOLD}git rebase --abort${RESET}"
    exit 1
  fi
fi

echo
echo "${BOLD}${GREEN}✔ Done. ${FEATURE_BRANCH} is now rebased onto ${BASE_BRANCH}.${RESET}"

